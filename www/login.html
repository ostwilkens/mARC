<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>
        async function login() {
            var username = document.getElementById("username").value;
            var password = document.getElementById("password").value;

            var homeserver = document.getElementById("homeserver").value;
            // trim homeserver url
            homeserver = homeserver.trim();
            // if homeserver is empty, add matrix.org
            if (homeserver == "") {
                homeserver = "https://matrix.org/";
            }
            // if homeserver doesn't end with a slash, add it
            if (homeserver[homeserver.length - 1] != "/") {
                homeserver += "/";
            }
            // if homeserver url is missing proto, add https
            if (homeserver.indexOf("://") == -1) {
                homeserver = "https://" + homeserver;
            }

            const wellKnownClientUrl = homeserver + ".well-known/matrix/client"
            const wellKnownClientJson = await fetch(wellKnownClientUrl).then(r => r.json())
            const homeserverbaseUrl = wellKnownClientJson["m.homeserver"]["base_url"]
            const loginUrl = homeserverbaseUrl + "_matrix/client/r0/login"

            const loginJson = await fetch(loginUrl, {
                method: 'POST',
                body: JSON.stringify({
                    "type": "m.login.password",
                    "user": username,
                    "password": password
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(r => r.json())

            if (loginJson["errcode"] == "M_FORBIDDEN") {
                alert("Invalid username or password")
            } else {
                localStorage.setItem("homeserver", homeserver)
                localStorage.setItem("access_token", loginJson["access_token"])
                localStorage.setItem("user_id", loginJson["user_id"])
                // window.location.replace("index.html")
            }
        }
    </script>
</head>
<body>
    <h1>Log in</h1>
    <form action="javascript:login()">
        <label for="homeserver">Homeserver:</label>
        <input type="text" name="homeserver" id="homeserver" placeholder="https://matrix.org/">
        <br>
        <label for="username">Username:</label>
        <input type="text" name="username" id="username" placeholder="Username" required>
        <br>
        <label for="password">Password:</label>
        <input type="password" name="password" id="password" placeholder="Password" required>
        <br>
        <input type="submit">
    </form>
</body>
</html>